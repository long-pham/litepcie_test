--- main.c.orig	2024-01-01 00:00:00.000000000 +0000
+++ main.c	2024-01-01 00:00:00.000000000 +0000
@@ -44,6 +44,7 @@
 #include "flags.h"
 #include "soc.h"
 
+#include "litepcie_latency.h"
 //#define DEBUG_CSR
 //#define DEBUG_MSI
 //#define DEBUG_POLL
@@ -110,6 +111,9 @@
 	bool writer;
 };
 
+/* Forward declaration for latency test */
+extern int litepcie_latency_test(struct litepcie_device *dev, struct litepcie_ioctl_latency *lat);
+
 static int litepcie_major;
 static int litepcie_minor_idx;
 static struct class *litepcie_class;
@@ -892,6 +896,24 @@
 		}
 
 	}
+	break;
+	case LITEPCIE_IOCTL_LATENCY_TEST:
+	{
+		struct litepcie_ioctl_latency m;
+		int ret_lat;
+
+		if (copy_from_user(&m, (void *)arg, sizeof(m))) {
+			ret = -EFAULT;
+			break;
+		}
+
+		ret_lat = litepcie_latency_test(dev, &m);
+		if (ret_lat == 0) {
+			if (copy_to_user((void *)arg, &m, sizeof(m))) {
+				ret = -EFAULT;
+				break;
+			}
+		}
+	}
 	break;
 	default:
 		ret = -ENOIOCTLCMD;